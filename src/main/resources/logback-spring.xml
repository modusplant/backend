<configuration>
    <!-- Spring Boot 기본 변수/패턴 불러오기 -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>

    <!-- ===== dev/local: 콘솔만 (Spring Boot 기본 콘솔 포맷 유지) ===== -->
    <root level="INFO">
        <!-- Spring Boot가 제공하는 CONSOLE appender -->
        <appender-ref ref="CONSOLE"/>
    </root>

    <!-- 도커에서만 true로 줄 토글 -->
    <springProperty name="LOG_TO_FILE" source="LOG_TO_FILE" defaultValue="false"/>
    <springProperty name="LOG_DIR"     source="LOG_DIR"     defaultValue=""/>

    <if condition='property("LOG_TO_FILE").equals("true")'>
        <then>
            <property name="LOG_DIR" value="${LOG_DIR:-/var/log/app}" />
            <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <file>${LOG_DIR}/app.log</file>
                <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                    <fileNamePattern>${LOG_DIR}/app.%d{yyyy-MM-dd}.log</fileNamePattern>
                    <maxHistory>14</maxHistory>
                </rollingPolicy>
                <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                    <providers>
                        <timestamp><fieldName>timestamp</fieldName><pattern>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</pattern></timestamp>
                        <pattern>
                            <pattern>
                                {
                                "timestamp":"%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ}",
                                "level":"%level",
                                "logger":"%logger{36}",
                                "thread":"%thread",
                                "message":"%replace(%msg){'\n','\\n'}",
                                "traceId":"%X{traceId:-unknown}"
                                }
                            </pattern>
                        </pattern>
                        <stackTrace/>
                    </providers>
                </encoder>
            </appender>
        </then>
        <!-- 필요하면 콘솔도 함께 남기고, 아니면 FILE_JSON만 -->
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE_JSON"/>
        </root>
    </if>

</configuration>
